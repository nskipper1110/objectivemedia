<html>
    <head>
        <script src="objectivemedia.js">
        </script>
        <script>
            function onOpen(){
                var r = Module._js_H263VideoEncoder_PlatformOpen(0, 320, 240, 20, 32, 256000, 0, 75, 75, 16);
                alert("Open Encoder returned " + r);
                r = Module._js_H263VideoDecoder_PlatformOpen(0, 320, 240, 20, 32, 256000, 0, 75, 75, 16);
                alert("Open Decoder returned " + r);
            }
            
            var encodedData = null;
            var decodedData = null;

            function onEncode(){
                var canvas = document.createElement("canvas");
                canvas.width = 320;
                canvas.height = 240;
                var ctx = canvas.getContext("2d");
                ctx.fillStyle = "red";
                ctx.fillRect(5,0,105, 240);
                ctx.fillStyle = "green";
                ctx.fillRect(110,0,105, 240);
                ctx.fillStyle = "blue";
                ctx.fillRect(215,0,105, 240);
                var imgData = ctx.getImageData(0,0,320,240);
                var size = imgData.data.BYTES_PER_ELEMENT * imgData.data.length;
                var srcPtr = Module._malloc(size);
                var dataHeap = new Uint8Array(Module.HEAPU8.buffer, srcPtr, size);
                dataHeap.set(new Uint8Array(imgData.data.buffer));
                var encresult = Module._js_H263VideoEncoder_PlatformEncode(dataHeap.byteOffset, size, 0);
                var outsize = Module._js_Helpers_BytesToInt(encresult);
                
                var result = Module._js_H263VideoDecoder_PlatformDecode(encresult+4, outsize, 0);
                if(result != 0){
                    var decsize = Module._js_Helpers_BytesToInt(result);
                    dataHeap = new Uint8Array(Module.HEAPU8.buffer, result + 4, decsize);
                    var destCanvas = document.getElementById("ResultCanvas");
                    ctx = destCanvas.getContext("2d");
                    imgData = ctx.createImageData(320,240);
                    for(var x = 0; x < decsize; x++){
                        imgData.data[x] = dataHeap[x];

                    }
                    ctx.putImageData(imgData, 0,0);
                }
            }

            function onClose(){
                var r = Module._js_H263VideoEncoder_PlatformClose();
                alert("Close returned " + r);

            }

        </script>
    </head>
    <body>
        <div>
            <button type="button" onclick="onOpen();">Open</button>
            <button type="button" onclick="onEncode();">Encode</button>
            <button type="button" onclick="onClose();">Close</button>
        </div>
        <div>
            <canvas width="320" height="240" id="ResultCanvas">

            </canvas>
        </div>
    </body>
</html>